{% extends 'base.html' %}

{% block title %}Mensagens Recebidas{% endblock %}

{% block content %}
<div class="max-w-7xl mx-auto py-12 px-4">

    <!-- Cabeçalho -->
    <div class="flex justify-between items-center mb-8">
        <h1 class="text-3xl font-extrabold text-green-800 flex items-center">
            <i class="fas fa-envelope-open-text mr-3 text-green-600"></i>
            Mensagens Recebidas
        </h1>
    </div>

    {% if messages %}
    <div class="bg-white rounded-2xl shadow-2xl border border-gray-200 overflow-x-auto">
        <table class="w-full text-sm">
            <thead class="bg-gray-100 text-gray-700 uppercase text-xs">
                <tr>
                    <th class="px-6 py-4 text-left">Nome</th>
                    <th class="px-6 py-4 text-left">Email</th>
                    <th class="px-6 py-4 text-left">Assunto</th>
                    <th class="px-6 py-4 text-left">Mensagem</th>
                    <th class="px-6 py-4 text-center">Status</th>
                    <th class="px-6 py-4 text-center">Ações</th>
                </tr>
            </thead>

            <tbody class="divide-y">
                {% for msg in messages %}
                <tr class="hover:bg-gray-50 transition" id="message-row-{{ msg.id }}">

                    <td class="px-6 py-4 font-medium text-gray-800">
                        {{ msg.name }}
                    </td>

                    <td class="px-6 py-4 text-gray-600">
                        {{ msg.email }}
                    </td>

                    <td class="px-6 py-4 text-gray-700 font-semibold">
                        {{ msg.subject }}
                    </td>

                    <td class="px-6 py-4 text-gray-600">
                        <a href="{% url 'admin_message_detail' msg.id %}"
                           class="text-blue-600 hover:underline">
                            {{ msg.message|truncatechars:60 }}
                        </a>
                    </td>

                    <!-- Status -->
                    <td class="px-6 py-4 text-center" id="status-{{ msg.id }}">
                        {% if msg.is_read %}
                            <span class="px-3 py-1 rounded-full text-xs font-semibold bg-green-100 text-green-700">
                                Lida
                            </span>
                        {% else %}
                            <span class="px-3 py-1 rounded-full text-xs font-semibold bg-red-100 text-red-700">
                                Não lida
                            </span>
                        {% endif %}
                    </td>

                    <!-- Ações -->
                    <td class="px-6 py-4">
                        <div class="flex justify-center gap-3 flex-wrap">

                            {% if not msg.is_read %}
                            <button
                                class="mark-read-btn px-3 py-1 rounded-lg text-xs font-semibold
                                       bg-blue-600 text-white hover:bg-blue-700 transition"
                                data-id="{{ msg.id }}">
                                Marcar como lida
                            </button>
                            {% endif %}

                            <a href="mailto:{{ msg.email }}"
                               class="px-3 py-1 rounded-lg text-xs font-semibold
                                      bg-green-600 text-white hover:bg-green-700 transition">
                                Responder
                            </a>

                            <button
                                class="delete-msg-btn px-3 py-1 rounded-lg text-xs font-semibold
                                       bg-red-600 text-white hover:bg-red-700 transition"
                                data-id="{{ msg.id }}">
                                Excluir
                            </button>

                        </div>
                    </td>
                </tr>

                {% empty %}
                <tr>
                    <td colspan="6" class="text-center py-10 text-gray-500">
                        Nenhuma mensagem encontrada.
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>

    <!-- Paginação -->
    <div class="mt-6 flex justify-center">
        <nav class="inline-flex items-center gap-2 text-sm">

            {% if messages.has_previous %}
            <a href="?page={{ messages.previous_page_number }}"
               class="px-4 py-2 rounded-lg bg-gray-200 hover:bg-gray-300 transition">
                Anterior
            </a>
            {% endif %}

            <span class="px-4 py-2 rounded-lg bg-gray-100 text-gray-700">
                Página {{ messages.number }} de {{ messages.paginator.num_pages }}
            </span>

            {% if messages.has_next %}
            <a href="?page={{ messages.next_page_number }}"
               class="px-4 py-2 rounded-lg bg-gray-200 hover:bg-gray-300 transition">
                Próxima
            </a>
            {% endif %}
        </nav>
    </div>

    {% else %}
    <p class="text-center text-gray-500 mt-10">Nenhuma mensagem encontrada.</p>
    {% endif %}
</div>

<!-- ================== SCRIPTS ================== -->

<script>
document.querySelectorAll('.mark-read-btn').forEach(button => {
    button.addEventListener('click', () => {
        const id = button.dataset.id;

        fetch(`/admin-area/messages/mark-read/${id}/`, {
            method: 'POST',
            headers: {
                'X-CSRFToken': '{{ csrf_token }}',
                'Content-Type': 'application/json'
            }
        })
        .then(r => r.json())
        .then(data => {
            if (data.status === 'success') {
                document.getElementById(`status-${id}`).innerHTML =
                    '<span class="px-3 py-1 rounded-full text-xs font-semibold bg-green-100 text-green-700">Lida</span>';
                button.remove();
            } else {
                alert('Erro ao marcar como lida.');
            }
        });
    });
});
</script>

<script>
function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        document.cookie.split(';').forEach(cookie => {
            cookie = cookie.trim();
            if (cookie.startsWith(name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
            }
        });
    }
    return cookieValue;
}
const csrftoken = getCookie('csrftoken');

document.querySelectorAll('.delete-msg-btn').forEach(button => {
    button.addEventListener('click', () => {
        const id = button.dataset.id;

        if (!confirm("Tem certeza que deseja excluir esta mensagem?")) return;

        fetch(`/admin-area/messages/delete/${id}/`, {
            method: 'POST',
            headers: {
                'X-CSRFToken': csrftoken,
                'Content-Type': 'application/json'
            }
        })
        .then(r => r.json())
        .then(data => {
            if (data.status === 'success') {
                const row = document.getElementById(`message-row-${id}`);
                if (row) row.remove();
            } else {
                alert("Erro ao excluir mensagem.");
            }
        });
    });
});
</script>

{% endblock %}
